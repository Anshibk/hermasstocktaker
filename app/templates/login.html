{% extends "base.html" %}

{% block extra_css %}
{{ super() }}
<style>
  html, body {
    height: 100%;
  }
  body {
    margin: 0;
    padding: 0;
    background: linear-gradient(to bottom, #cceeff, #66ccff);
    overflow: hidden;
  }
  #login-ocean {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    display: block;
    pointer-events: none;
  }
  .login-wrap {
    position: relative;
    min-height: 100vh;
  }
</style>
{% endblock %}

{% block content %}
<div class="login-wrap flex items-center justify-center px-4">
  <canvas id="login-ocean"></canvas>
  <div class="relative z-10 w-full max-w-md">
    <div class="bg-white/80 backdrop-blur-xl p-8 rounded-3xl shadow-2xl space-y-6 border border-white/40">
      <div class="text-center space-y-2">
        <h1 class="text-3xl font-semibold text-slate-800">Hermas Stock Taker</h1>
        <p class="text-sm text-slate-600">Secure access with your Google Workspace or Gmail account.</p>
      </div>
      {% if google_client_id %}
      <div class="space-y-5">
        <div class="grid gap-3">
          <div id="google-signin"></div>
          <div id="google-signup"></div>
        </div>
        <div class="flex flex-col gap-3 text-sm text-slate-500 text-center">
          <p>Use your authorized Gmail account to sign in or sign up.</p>
          {% if superuser_email %}
          <a id="request-access" class="inline-flex items-center justify-center gap-2 rounded-xl border border-slate-200 px-4 py-2 font-semibold text-slate-600 hover:bg-slate-50 transition" href="mailto:{{ superuser_email }}?subject=Hermas%20Stock%20Taker%20Access&body=Hi%2C%20please%20invite%20me%20to%20Hermas%20Stock%20Taker.">
            Need an invite? Contact the admin
          </a>
          {% endif %}
        </div>
        <p id="status" class="text-sm text-slate-500 hidden text-center">Signing you in…</p>
        <p id="error" class="text-sm text-red-600 hidden text-center">Unable to sign in with Google. Please try again.</p>
      </div>
      {% else %}
      <div class="bg-red-50 border border-red-200 rounded-2xl p-4 text-sm text-red-700 text-center">
        Google Sign-In is not configured. Please contact your administrator.
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
const canvas = document.getElementById("login-ocean");
const ctx = canvas.getContext("2d");
let width, height;
let time = 0;

function resizeOcean() {
  width = canvas.width = window.innerWidth;
  height = canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeOcean);
resizeOcean();

function wave(yOffset, amplitude, wavelength, speed, color, roughness = 0.3) {
  ctx.beginPath();
  ctx.moveTo(0, height);
  for (let x = 0; x <= width; x++) {
    let y = yOffset
      + Math.sin((x / wavelength) + time * speed) * amplitude
      + Math.sin((x / (wavelength / 2)) + time * speed * 1.5) * amplitude * roughness
      + Math.sin((x / (wavelength / 4)) + time * speed * 2) * amplitude * roughness * 0.5;
    ctx.lineTo(x, y);
  }
  ctx.lineTo(width, height);
  ctx.closePath();
  ctx.fillStyle = color;
  ctx.fill();
}

function animateOcean() {
  ctx.clearRect(0, 0, width, height);
  time += 0.02;

  const gradient = ctx.createLinearGradient(0, 0, 0, height);
  gradient.addColorStop(0, "#cceeff");
  gradient.addColorStop(1, "#66ccff");
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, width, height);

  wave(height * 0.65, 80, 500, 0.4, "rgba(102, 204, 255, 0.5)", 0.4);
  wave(height * 0.72, 70, 400, 0.6, "rgba(51, 153, 255, 0.6)", 0.4);
  wave(height * 0.78, 60, 300, 0.8, "rgba(0, 128, 255, 0.7)", 0.4);
  wave(height * 0.85, 50, 200, 1.0, "rgba(0, 102, 204, 0.9)", 0.5);

  requestAnimationFrame(animateOcean);
}
animateOcean();

const statusEl = document.getElementById('status');
const errorEl = document.getElementById('error');
const googleClientId = {{ google_client_id|tojson }};

function setStatus(message) {
  if (!statusEl) return;
  if (message) {
    statusEl.textContent = message;
    statusEl.classList.remove('hidden');
  } else {
    statusEl.classList.add('hidden');
  }
}

function showError(message) {
  if (!errorEl) return;
  errorEl.textContent = message || 'Unable to sign in with Google. Please try again.';
  errorEl.classList.remove('hidden');
  setStatus('');
}

async function postCredential(credential) {
  if (!credential) {
    showError('Missing Google credential.');
    return;
  }
  setStatus('Signing you in…');
  if (errorEl) {
    errorEl.classList.add('hidden');
  }
  try {
    const res = await fetch('/api/v1/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ credential }),
    });
    if (res.ok) {
      window.location.href = '/dashboard';
      return;
    }
    const payload = await res.json().catch(() => ({}));
    const detail = payload?.detail || 'Your Google account is not authorized.';
    showError(detail);
  } catch (err) {
    console.error(err);
    showError('Unable to reach the server. Please try again.');
  } finally {
    setStatus('');
  }
}

function handleGoogleCredential(response) {
  if (!response || !response.credential) {
    showError('Invalid Google response.');
    return;
  }
  postCredential(response.credential);
}

function initializeGoogleSignIn() {
  if (!googleClientId || !window.google || !window.google.accounts || !window.google.accounts.id) {
    return false;
  }

  window.google.accounts.id.initialize({
    client_id: googleClientId,
    callback: handleGoogleCredential,
    ux_mode: 'popup',
    context: 'signin',
  });

  const signInContainer = document.getElementById('google-signin');
  if (signInContainer && !signInContainer.hasChildNodes()) {
    window.google.accounts.id.renderButton(signInContainer, {
      type: 'standard',
      shape: 'pill',
      theme: 'filled_blue',
      text: 'signin_with',
      size: 'large',
      logo_alignment: 'left',
    });
  }

  const signUpContainer = document.getElementById('google-signup');
  if (signUpContainer && !signUpContainer.hasChildNodes()) {
    window.google.accounts.id.renderButton(signUpContainer, {
      type: 'standard',
      shape: 'pill',
      theme: 'outline',
      text: 'signup_with',
      size: 'large',
      logo_alignment: 'left',
    });
  }

  return true;
}

function waitForGoogle(initAttempts = 0) {
  if (initializeGoogleSignIn()) {
    return;
  }

  if (initAttempts > 20) {
    console.warn('Google Sign-In script not loaded.');
    return;
  }

  setTimeout(() => waitForGoogle(initAttempts + 1), 150);
}

window.addEventListener('DOMContentLoaded', () => {
  if (!googleClientId) {
    return;
  }
  waitForGoogle();
});

window.handleGoogleCredential = handleGoogleCredential;
</script>
{% endblock %}
