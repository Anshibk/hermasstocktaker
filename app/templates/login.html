{% extends "base.html" %}

{% block extra_css %}
{{ super() }}
<style>
  html, body {
    height: 100%;
  }
  body {
    margin: 0;
    padding: 0;
    background: linear-gradient(to bottom, #cceeff, #66ccff);
    overflow: hidden;
  }
  #login-ocean {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    display: block;
    pointer-events: none;
  }
  .login-wrap {
    position: relative;
    min-height: 100vh;
  }
</style>
{% endblock %}

{% block content %}
<div class="login-wrap flex items-center justify-center px-4">
  <canvas id="login-ocean"></canvas>
  <div class="relative z-10 w-full max-w-md">
    <div class="bg-white/80 backdrop-blur-xl p-8 rounded-3xl shadow-2xl space-y-6 border border-white/40">
        <div class="text-center space-y-2">
          <h1 class="text-3xl font-semibold text-slate-800">Hermas Stock Taker</h1>
          <p class="text-sm text-slate-600">Use your Gmail account or invitation code to access the workspace.</p>
        </div>
      <div class="space-y-4">
        <p class="text-sm text-slate-600 text-center">Sign in with your Gmail account to continue.</p>
        <button id="btn-google-signin" class="w-full flex items-center justify-center gap-2 bg-sky-600 hover:bg-sky-700 text-white rounded-xl py-2.5 font-semibold shadow-lg shadow-sky-600/30 transition">
          <span>üîê</span>
          <span>Sign in with Google</span>
        </button>
        <div class="border-t border-slate-200 pt-4">
          <button id="btn-invite-toggle" class="w-full text-sky-700 hover:text-sky-800 text-sm font-semibold flex items-center justify-center gap-1">
            <span>‚úâÔ∏è</span>
            <span>Have an invitation? Join now</span>
          </button>
          <div id="invite-panel" class="mt-4 space-y-3 hidden">
            <div>
              <label class="block text-sm font-medium text-slate-600 mb-1" for="invite-code">Invitation code</label>
              <input id="invite-code" class="w-full border border-slate-300/70 rounded-xl px-3 py-2.5 bg-white/80 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Paste your invitation code" />
            </div>
            <button id="btn-google-signup" class="w-full flex items-center justify-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl py-2.5 font-semibold shadow-lg shadow-emerald-600/30 transition">
              <span>üöÄ</span>
              <span>Join with Google</span>
            </button>
            <p id="invite-error" class="text-sm text-red-600 hidden text-center">Enter a valid invitation code.</p>
          </div>
        </div>
        <p id="error" class="text-sm text-red-600 hidden text-center"></p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
const canvas = document.getElementById("login-ocean");
const ctx = canvas.getContext("2d");
let width, height;
let time = 0;

function resizeOcean() {
  width = canvas.width = window.innerWidth;
  height = canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeOcean);
resizeOcean();

function wave(yOffset, amplitude, wavelength, speed, color, roughness = 0.3) {
  ctx.beginPath();
  ctx.moveTo(0, height);
  for (let x = 0; x <= width; x++) {
    let y = yOffset
      + Math.sin((x / wavelength) + time * speed) * amplitude
      + Math.sin((x / (wavelength / 2)) + time * speed * 1.5) * amplitude * roughness
      + Math.sin((x / (wavelength / 4)) + time * speed * 2) * amplitude * roughness * 0.5;
    ctx.lineTo(x, y);
  }
  ctx.lineTo(width, height);
  ctx.closePath();
  ctx.fillStyle = color;
  ctx.fill();
}

function animateOcean() {
  ctx.clearRect(0, 0, width, height);
  time += 0.02;

  const gradient = ctx.createLinearGradient(0, 0, 0, height);
  gradient.addColorStop(0, "#cceeff");
  gradient.addColorStop(1, "#66ccff");
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, width, height);

  wave(height * 0.65, 80, 500, 0.4, "rgba(102, 204, 255, 0.5)", 0.4);
  wave(height * 0.72, 70, 400, 0.6, "rgba(51, 153, 255, 0.6)", 0.4);
  wave(height * 0.78, 60, 300, 0.8, "rgba(0, 128, 255, 0.7)", 0.4);
  wave(height * 0.85, 50, 200, 1.0, "rgba(0, 102, 204, 0.9)", 0.5);

  requestAnimationFrame(animateOcean);
}
animateOcean();

const error = document.getElementById('error');
const inviteError = document.getElementById('invite-error');
const invitePanel = document.getElementById('invite-panel');
const inviteToggle = document.getElementById('btn-invite-toggle');
const inviteInput = document.getElementById('invite-code');
const params = new URLSearchParams(window.location.search);

function showError(message) {
  if (!message) {
    error.classList.add('hidden');
    error.textContent = '';
    return;
  }
  error.textContent = message;
  error.classList.remove('hidden');
}

function showInviteError(message) {
  if (!message) {
    inviteError.classList.add('hidden');
    inviteError.textContent = '';
    return;
  }
  inviteError.textContent = message;
  inviteError.classList.remove('hidden');
}

function decodeError(code) {
  const map = {
    missing_code: 'Google did not provide a login code. Please try again.',
    access_denied: 'Google sign-in was cancelled.',
  };
  return map[code] || code.replace(/\+/g, ' ');
}

function startGoogleFlow(invitationToken) {
  showError('');
  showInviteError('');
  const url = new URL('/api/v1/auth/google/start', window.location.origin);
  if (invitationToken) {
    url.searchParams.set('invitation_token', invitationToken);
  }
  const nextParam = params.get('next');
  if (nextParam && nextParam.startsWith('/')) {
    url.searchParams.set('next', nextParam);
  }
  window.location.href = url.toString();
}

document.getElementById('btn-google-signin')?.addEventListener('click', (event) => {
  event.preventDefault();
  startGoogleFlow(null);
});

document.getElementById('btn-google-signup')?.addEventListener('click', (event) => {
  event.preventDefault();
  const token = (inviteInput?.value || '').trim();
  if (!token) {
    showInviteError('Enter your invitation code.');
    return;
  }
  startGoogleFlow(token);
});

inviteToggle?.addEventListener('click', (event) => {
  event.preventDefault();
  invitePanel.classList.toggle('hidden');
  if (!invitePanel.classList.contains('hidden')) {
    inviteInput?.focus();
  }
});

const inviteParam = params.get('invite');
if (inviteParam && inviteInput) {
  invitePanel.classList.remove('hidden');
  inviteInput.value = inviteParam;
}

const errorParam = params.get('error');
if (errorParam) {
  showError(decodeError(errorParam));
}
</script>
{% endblock %}
